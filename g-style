#!/usr/bin/env bash
# G-Style 0.1 — namespace-only spin-up → MQTT ping → spin-down with clean state
# Commands: start | stop | restart | status

set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CFG_NS="$ROOT_DIR/config/namespace.yml"

need_cmd(){ command -v "$1" >/dev/null 2>&1; }
ensure_deps() {
  echo "==> Checking dependencies…"
  local pkgs=()
  need_cmd ip             || pkgs+=(iproute2)
  need_cmd systemctl      || pkgs+=(systemd)
  need_cmd yq             || pkgs+=(yq)
  need_cmd mosquitto      || pkgs+=(mosquitto)
  need_cmd mosquitto_pub  || pkgs+=(mosquitto-clients)
  if ((${#pkgs[@]})); then
    echo "Installing: ${pkgs[*]}"
    sudo apt update -y
    sudo apt install -y "${pkgs[@]}"
  fi
}

yq_val(){ yq -r ".$1" "$CFG_NS"; }

versions() {
  echo "— Versions —"
  mosquitto -h 2>/dev/null | head -n 1 || echo "mosquitto: (missing)"
  mosquitto_pub -h 2>/dev/null | head -n 1 || echo "mosquitto-clients: (missing)"
  ip -V
  yq --version || true
  echo
}

mqtt_ping() {
  local NS_IP MSG
  NS_IP="$(yq_val ns_ip_cidr)"; NS_IP="${NS_IP%/*}"
  MSG="hello-$(date +%s)"
  mosquitto_pub -h "$NS_IP" -p 1883 -t gstyle/test -m "$MSG" -r || true
  mosquitto_sub -h "$NS_IP" -p 1883 -t gstyle/test -C 1 -W 2 | grep -q "$MSG" \
    && echo "✅ MQTT round-trip OK" || echo "⚠️  MQTT no response"
}

state_report() {
  local NS HOST_IF
  NS="$(yq_val name)"
  HOST_IF="$(yq_val host_if)"
  echo "— State report —"
  echo "[netns]"; ip netns list || true
  echo; echo "[links matching ${HOST_IF}]"
  ip -br link 2>/dev/null | grep -E "$HOST_IF" || echo "(none)"
  echo; echo "[services]"
  systemctl list-units --type=service --state=running 2>/dev/null | grep -E 'gstyle-' || echo "(none)"
  echo; echo "[mosquitto pids on host]"
  pgrep -a mosquitto || echo "(none)"
  echo
}

do_start() {
  echo "==> G-Style start"
  ensure_deps
  versions
  sudo "$ROOT_DIR/scripts/ns_up.sh"
  sudo "$ROOT_DIR/scripts/ingest_up.sh"
  echo; echo "— Health —"
  mqtt_ping
  echo; state_report
}

do_stop() {
  echo "==> G-Style stop"
  sudo "$ROOT_DIR/scripts/ingest_down.sh"
  sudo "$ROOT_DIR/scripts/ns_down.sh"
  echo; echo "— Post-stop verification —"
  versions
  state_report
  echo "✅ Host returned to default (no netns, no services)"
}

do_status() {
  versions
  state_report
  echo "— Live MQTT check —"
  mqtt_ping
}

case "${1:-}" in
  start)   do_start ;;
  stop)    do_stop ;;
  restart) do_stop; echo; do_start ;;
  status)  do_status ;;
  *) echo "Usage: $(basename "$0") {start|stop|restart|status}"; exit 1 ;;
esac
